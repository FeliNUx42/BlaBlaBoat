{% extends "layout/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

{% for field, errors in form.errors.items() %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ errors }}
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
{% endfor %}

<form class="form-horizontal" method="POST" action="" enctype="multipart/form-data">

  <div class="form-group">
    <h2>{{ title }}</h2>
  </div>

  {{ form.csrf_token() }}

  <div class="form-group">
    <label class="control-label" for="">{{ form.title.label }}</label>
    <div>{{ form.title(class="form-control") }}</div>
  </div>

  <div class="form-group">
    <label class="control-label" for="">{{ form.description.label }}</label>
    <div>{{ form.description(class="form-control", rows="8") }}</div>
  </div>

  <div class="form-group destinations">
    <label for="" class="control-label">{{ form.dest.label }}</label>
    {% for i, d in enumerate(form.dest) %}
    <div class="dest-{{ i }} mb-4">
      <div class="input-group mb-2">
        <div class="input-group-prepend">
          <span class="input-group-text">{{ d.place.label.text }}</span>
        </div>
        {{ d.place(class="form-control") }}
      </div>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text">{{ d.arr_date.label.text }}</span>
        </div>
        {{ d.arr_date(class="form-control") }}
        <div class="input-group-prepend">
          <span class="input-group-text">{{ d.dep_date.label.text }}</span>
        </div>
        {{ d.dep_date(class="form-control") }}
        {% if i < len(form.dest) - 1 %}
        <div class="input-group-append">
          <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown">
            Actions
          </button>
          <div class="dropdown-menu">
            {% if i %}
            <button class="dropdown-item" type="button" onclick="delete_stopover(this)">Delete this Stopover</button>
            {% endif %}
            <button class="dropdown-item" type="button" onclick="add_stopover(this)">Add Stopover below</button>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="custom-file mt-2 mb-3">
    {{ form.banner(class="custom-file-input", id="file-banner") }}
    {{ form.banner.label(class="custom-file-label", for="file-banner") }}
  </div>

  <div class="form-group">
    <label class="control-label" for="">{{ form.boat_type.label }}</label>
    <div>{{ form.boat_type(class="form-control") }}</div>
  </div>

  <div class="form-group">
    <label class="control-label" for="">{{ form.boat_model.label }}</label>
    <div>{{ form.boat_model(class="form-control") }}</div>
  </div>

  <div class="form-group">
    <label class="control-label" for="">{{ form.sailing_mode.label }}</label>
    <div>{{ form.sailing_mode(class="form-control") }}</div>
  </div>

  <div class="form-group">
    <label class="control-label" for="">{{ form.travel_expenses.label }}</label>
    <div>{{ form.travel_expenses(class="form-control") }}</div>
  </div>

  <div class="form-group">
    <label class="control-label" for="">{{ form.qualif_level.label }}</label>
    <div>{{ form.qualif_level(class="form-control") }}</div>
  </div>

  <div class="form-group">
    <div>{{ form.submit(class="btn btn-primary")}}</div>
  </div>

</form>

<script>  
  function delete_stopover(delBtn) {
    let obj = delBtn.parentNode.parentNode.parentNode.parentNode;
    let index = Number(obj.classList[0].split("-")[1]);

    $("."+obj.classList[0]).slideUp();

    let children = Array.from(obj.parentNode.children).filter(elem => {
      let num = elem.classList[0].split("-")[1];
      if (!num) return false;
      return Number(num) > index;
    });

    children.forEach((item, i) => {
      let num = index + i + 1;
      if (item.querySelector("span.input-group-text").innerText.startsWith("Stopover")) {
        item.querySelector("span.input-group-text").innerText = "Stopover " + (num-1);
      }
      item.className = item.className.replace("dest-"+num, "dest-"+(num-1));
      item.querySelectorAll("input").forEach(inp => {
        inp.name = inp.name.replace("dest-"+num, "dest-"+(num-1));
        inp.id = inp.id.replace("dest-"+num, "dest-"+(num-1));
      });
    });

    window.setTimeout(()=>{obj.remove();}, 1000);
  }

  function add_stopover(addBtn) {
    let obj = addBtn.parentNode.parentNode.parentNode.parentNode;
    let index = Number(obj.classList[0].split("-")[1]);

    let children = Array.from(obj.parentNode.children).filter(elem => {
      let num = elem.classList[0].split("-")[1];
      if (!num) return false;
      return Number(num) > index;
    });

    children.forEach((item, i) => {
      let num = index + i + 1;
      if (item.querySelector("span.input-group-text").innerText.startsWith("Stopover")) {
        item.querySelector("span.input-group-text").innerText = "Stopover " + (num+1);
      }
      item.className = item.className.replace("dest-"+num, "dest-"+(num+1));
      item.querySelectorAll("input").forEach(inp => {
        inp.name = inp.name.replace("dest-"+num, "dest-"+(num+1));
        inp.id = inp.id.replace("dest-"+num, "dest-"+(num+1));
      });
    });

    let newObj = document.createElement("div");
    newObj.classList.add("dest-"+(index+1));
    newObj.classList.add("mb-4");
    newObj.setAttribute("style", "display:none;")
    newObj.innerHTML = `<div class="input-group mb-2"><div class=input-group-prepend><span class=input-group-text>Stopover 1</span></div><input class=form-control id=dest-1-place name=dest-1-place maxlength=64></div><div class=input-group><div class=input-group-prepend><span class=input-group-text>Date of arrival</span></div><input class=form-control id=dest-1-arr_date name=dest-1-arr_date type=date><div class=input-group-prepend><span class=input-group-text>Date of departure</span></div><input class=form-control id=dest-1-dep_date name=dest-1-dep_date type=date><div class=input-group-append><button class="btn btn-outline-secondary dropdown-toggle"type=button data-toggle=dropdown>Actions</button><div class=dropdown-menu><button class=dropdown-item type=button onclick=delete_stopover(this)>Delete this Stopover</button> <button class=dropdown-item type=button onclick=add_stopover(this)>Add Stopover below</button></div></div></div>`;
    newObj.innerHTML = newObj.innerHTML.replaceAll("dest-1", "dest-"+(index+1)).replace("Stopover 1", "Stopover "+Number(index+1));

    obj.parentNode.insertBefore(newObj, obj.nextElementSibling);
    $(".dest-"+(index+1)).slideDown();
  }
</script>

<!--<script>  
  function delete_stopover(name) {
    let obj = document.querySelector("."+name);
    $("."+name).slideUp();
    let index = Number(obj.querySelector("input[type='number']").value);
    obj.querySelector("input[type='number']").value = -1;

    let children = Array.from(obj.parentNode.children).filter(elem => {
      let num = elem.querySelector("input[type='number']");
      if (!num) return false;
      return Number(num.value) > index;
    });

    children.forEach((item, i) => {
      let num = index + i + 1;
      if (item.querySelector("span.input-group-text").innerText.startsWith("Stopover")) {
        item.querySelector("span.input-group-text").innerText = "Stopover " + (num-1)
      }
      item.querySelector("input[type='number']").value = num-1;
    });
  }

  function add_stopover(name) {
    let obj = document.querySelector("."+name);
    let index = Number(obj.querySelector("input[type='number']").value);
    let count = obj.parentNode.childElementCount - 1;

    let children = Array.from(obj.parentNode.children).filter(elem => {
      let num = elem.querySelector("input[type='number']");
      if (!num) return false;
      return Number(num.value) > index;
    });

    children.forEach((item, i) => {
      let num = index + i + 1;
      if (item.querySelector("span.input-group-text").innerText.startsWith("Stopover")) {
        item.querySelector("span.input-group-text").innerText = "Stopover " + (num+1)
      }
      item.querySelector("input[type='number']").value = num+1;
    });

    let newObj = document.createElement("div");
    newObj.classList.add("mb-4");
    newObj.classList.add("dest-"+count);
    newObj.setAttribute("style", "display:none;")
    newObj.innerHTML = `<input id=dest-1-order name=dest-1-order required type=number hidden value=1><div class="input-group mb-2"><div class=input-group-prepend><span class=input-group-text>Stopover 1</span></div><input id=dest-1-place name=dest-1-place required class=form-control maxlength=64></div><div class=input-group><div class=input-group-prepend><span class=input-group-text>Date of arrival</span></div><input id=dest-1-arr_date name=dest-1-arr_date required class=form-control type=date><div class=input-group-prepend><span class=input-group-text>Date of departure</span></div><input id=dest-1-dep_date name=dest-1-dep_date required class=form-control type=date><div class=input-group-append><button class="btn btn-outline-secondary dropdown-toggle"type=button data-toggle=dropdown>Actions</button><div class=dropdown-menu><button class=dropdown-item type=button onclick='delete_stopover("dest-1")'>Delete this Stopover</button> <button class=dropdown-item type=button onclick='add_stopover("dest-1")'>Add Stopover below</button></div></div></div>`;
    newObj.innerHTML = newObj.innerHTML.replaceAll("dest-1", "dest-"+count).replace("Stopover 1", "Stopover "+Number(index+1));
    newObj.querySelector("input[type='number']").value = index+1;

    obj.parentNode.insertBefore(newObj, obj.nextElementSibling);
    $(".dest-"+count).slideDown();
  }
</script>--->

<!--<script>
  function delete_stopover(name) {
    let obj = document.querySelector("."+name);
    let index = Number(name.split("-")[1]);

    let children = Array.from(obj.parentNode.children).filter(elem => {
      let num = elem.classList[0].split("-")[1];
      return Number(num) > index;
    });

    children.forEach((item, i) => {
      let num = index + i + 1;
      item.outerHTML = item.outerHTML.replaceAll("dest-"+num, "dest-"+(num-1)).replace("Stopover "+num, "Stopover "+(num-1));
    });

    obj.remove();
  }

  function add_stopover(name) {
    let obj = document.querySelector("."+name);
    let index = Number(name.split("-")[1]);

    let children = Array.from(obj.parentNode.children).filter(elem => {
      let num = elem.classList[0].split("-")[1];
      return Number(num) > index;
    });

    children.forEach((item, i) => {
      let num = index + i + 1;
      item.outerHTML = item.outerHTML.replaceAll("dest-"+num, "dest-"+(num+1)).replace("Stopover "+num, "Stopover "+(num+1));
    });

    let newObj = document.createElement("div");
    newObj.className = "dest-"+(index+1)+" mb-4";
    newObj.innerHTML = `<div class="input-group mb-2"> <div class="input-group-prepend"> <span class="input-group-text">Stopover 1</span> </div> <input class="form-control" id="dest-1-place" maxlength="64" name="dest-1-place" required type="text" value=""> </div> <div class="input-group"> <div class="input-group-prepend"> <span class="input-group-text">Date of arrival</span> </div> <input class="form-control" id="dest-1-arr_date" name="dest-1-arr_date" required type="date" value=""> <div class="input-group-prepend"> <span class="input-group-text">Date of departure</span> </div> <input class="form-control" id="dest-1-dep_date" name="dest-1-dep_date" required type="date" value=""> <div class="input-group-append"> <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown"> Actions </button> <div class="dropdown-menu"> <button class="dropdown-item" type="button" onclick="delete_stopover('dest-1')">Delete this Stopover</button> <button class="dropdown-item" type="button" onclick="add_stopover('dest-1')">Add Stopover below</button> </div> </div> </div>`;
    newObj.innerHTML = newObj.innerHTML.replaceAll("dest-1", "dest-"+(index+1)).replace("Stopover 1", "Stopover "+(index+1));
    
    obj.parentNode.insertBefore(newObj, obj.nextElementSibling);
  }
</script>-->
{% endblock %}